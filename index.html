<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>可穿戴 GPS 轨迹显示 (MQTT)</title>
    <style>
        html, body, #map { width: 100%; height: 100%; margin: 0; padding: 0; }
        #info {
            position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.85);
            padding: 8px; border-radius: 4px;
        }
        button { margin: 4px 0; }
    </style>

    <!-- 高德地图 JS API -->
    <script src="https://webapi.amap.com/maps?v=2.0&key=99aaad9da054b71f551fb168b5a88088"></script>
    <!-- MQTT.js -->
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
    <div id="map"></div>
    <div id="info">
        <div>速度: <span id="speed">0</span> km/h</div>
        <button onclick="clearPath()">清空轨迹</button>
        <button onclick="exportGPX()">导出 GPX</button>
    </div>

    <script>
        // ---------------- 高德地图初始化 ----------------
        const map = new AMap.Map('map', {
            center: [116.397428, 39.90923],
            zoom: 16
        });

        let path = [];
        let markers = [];

        const polyline = new AMap.Polyline({
            path: path,
            strokeColor: "#FF0000",
            strokeWeight: 4,
            map: map
        });

        function addMarker(lat, lon, speed){
            path.push([lon, lat]);
            polyline.setPath(path);
            document.getElementById('speed').innerText = speed.toFixed(1);

            // 添加起点/终点标记
            if(path.length === 1){
                const startMarker = new AMap.Marker({
                    position: [lon, lat],
                    title: '起点',
                    map: map
                });
                markers.push(startMarker);
            } else {
                if(markers.length > 1){
                    markers[markers.length-1].setMap(null); // 删除旧终点
                    markers.pop();
                }
                const endMarker = new AMap.Marker({
                    position: [lon, lat],
                    title: '终点',
                    map: map
                });
                markers.push(endMarker);
            }

            map.setCenter([lon, lat]);
        }

        function clearPath(){
            path = [];
            polyline.setPath(path);
            markers.forEach(m => m.setMap(null));
            markers = [];
            document.getElementById('speed').innerText = 0;
        }

        function exportGPX(){
            let gpx = '<?xml version="1.0"?>\n<gpx version="1.1" creator="GPS Web">\n<trk>\n<trkseg>\n';
            path.forEach(p => {
                gpx += `<trkpt lat="${p[1]}" lon="${p[0]}"></trkpt>\n`;
            });
            gpx += '</trkseg>\n</trk>\n</gpx>';

            const blob = new Blob([gpx], {type: 'application/gpx+xml'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'track.gpx';
            a.click();
            URL.revokeObjectURL(url);
        }

        // ---------------- MQTT 数据接收 ----------------
        const brokerUrl = 'wss://test.mosquitto.org:8081/mqtt'; // 可替换为你的云端 MQTT Broker
        const topic = 'gps/track';

        const client = mqtt.connect(brokerUrl);

        client.on('connect', () => {
            console.log('Connected to MQTT broker');
            client.subscribe(topic, (err) => {
                if(!err) console.log(`Subscribed to topic: ${topic}`);
            });
        });

        client.on('message', (topic, message) => {
            try{
                const data = JSON.parse(message.toString());
                const lat = parseFloat(data.lat);
                const lon = parseFloat(data.lon);
                const speed = parseFloat(data.speed);
                addMarker(lat, lon, speed);
            } catch(e){
                console.error('Invalid MQTT message:', e);
            }
        });
    </script>
</body>
</html>
