// ---------- 华为云 WSS MQTT (设备接入) ----------
let client = null;
const mqttConfig = {
  hostname: '5791e7b116.st1.iotda-device.cn-north-4.myhuaweicloud.com',
  clientId: '68bfe47d32771f177b5e1bf8_guiji-001_0_0_2025090914',
  username: '68bfe47d32771f177b5e1bf8_guiji-001',
  password: '7c4546ca912f90c51aefe02f5cd58757cfab4789aac12ab63a6cb905cf7e16bb',
  topic: '$oc/devices/68bfe47d32771f177b5e1bf8_guiji-001/sys/properties/set/#'
};

// ---------- 华为云 WSS MQTT (应用接入) ----------
let appClient = null;
const mqttAppConfig = {
  hostname: "mqtts-cn-north-4.myhuaweicloud.com", // 确认控制台的MQTT推送域名
  port: 443,
  clientId: "webapp_" + Math.random().toString(16).substr(2, 8),
  username: "QpbDtCqL",  // access_key
  password: "yNy6DBpsHET9GYUTrPKJ4yAYSJd3Vgts", // access_code
  topic: "gpshtml" // 转发Topic
};

// ---------- 设备接入 ----------
function connectMQTT() {
  if (client && client.connected) return;
  const url = `wss://${mqttConfig.hostname}/mqtt`;
  console.log('设备接入: 尝试连接 WSS URL:', url);

  client = mqtt.connect(url, {
    clientId: mqttConfig.clientId,
    username: mqttConfig.username,
    password: mqttConfig.password,
    protocol: 'wss',
    clean: true
  });

  client.on('connect', () => {
    console.log('✅ 设备MQTT 已连接');
    client.subscribe(mqttConfig.topic, (err) => {
      if (err) console.error('订阅失败:', err);
      else console.log('订阅成功:', mqttConfig.topic);
    });
  });

  client.on('message', (topic, message) => {
    try {
      const data = JSON.parse(message.toString());
      handleModelData(data);
    } catch (e) {}
  });
}

function disconnectMQTT() {
  if (client && client.connected) {
    client.end();
    console.log('设备MQTT 已断开');
  }
}

// ---------- 应用接入 ----------
function connectAppMQTT() {
  if (appClient && appClient.connected) return;
  const url = `wss://${mqttAppConfig.hostname}:${mqttAppConfig.port}/mqtt`;
  console.log("应用接入: 尝试连接 WSS URL:", url);

  appClient = mqtt.connect(url, {
    clientId: mqttAppConfig.clientId,
    username: mqttAppConfig.username,
    password: mqttAppConfig.password,
    protocol: "wss",
    clean: true
  });

  appClient.on("connect", () => {
    console.log("✅ 应用MQTT 已连接");
    appClient.subscribe(mqttAppConfig.topic, (err) => {
      if (err) console.error("应用订阅失败:", err);
      else console.log("应用已订阅:", mqttAppConfig.topic);
    });
  });

  appClient.on("message", (topic, message) => {
    try {
      const data = JSON.parse(message.toString());
      console.log("📩 应用收到数据:", data);
      handleModelData(data);
    } catch (e) {}
  });
}

function disconnectAppMQTT() {
  if (appClient && appClient.connected) {
    appClient.end();
    console.log("应用MQTT 已断开");
  }
}
