<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>GPS + 设备影子实时显示</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://webapi.amap.com/maps?v=2.0&key=99aaad9da054b71f551fb168b5a88088"></script>
  <style>
    html, body { height: 100%; margin:0; }
    #mapContainer { width:100%; height:80%; }
    #controls {
      position:absolute; top:5px; left:5px;
      background: rgba(255,255,255,0.9);
      padding:10px; border-radius:5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      z-index:999;
    }
    button { margin-right:5px; margin-bottom:5px; }
    #status { margin-top:5px; }
  </style>
</head>
<body>

<div id="controls">
  <button id="startBtn">启动模拟</button>
  <button id="stopBtn">停止模拟</button>
  <button onclick="clearPath()">清除轨迹</button>
  <button id="connectBtn">连接华为云 MQTT</button>
  <button id="disconnectBtn">断开 MQTT</button>
  <div id="status">MQTT状态: 未连接</div>
  <div id="shadow">物模型数据: 无</div>
</div>

<div id="mapContainer"></div>

<script>
  // ---------- 地图 ----------
  let initialPos = [108.073, 34.280]; // 默认坐标
  const map = new AMap.Map('mapContainer', { zoom:16, center: initialPos });
  const marker = new AMap.Marker({ position: initialPos, map: map });

  let path = [];
  const polyline = new AMap.Polyline({
    path: [initialPos],
    strokeColor:"#FF0000",
    strokeWeight:4,
    map: map
  });

  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(pos=>{
      initialPos = [pos.coords.longitude, pos.coords.latitude];
      marker.setPosition(initialPos);
      map.setCenter(initialPos);
      polyline.setPath([initialPos]);
    });
  }

  function clearPath(){
    path = [];
    polyline.setPath([initialPos]);
    marker.setPosition(initialPos);
    map.setCenter(initialPos);
    console.log('轨迹已清除');
  }

  // ---------- GPS 模拟 ----------
  let simulateInterval = null;
  function startSimulation(){ 
    if(simulateInterval) return;
    simulateInterval = setInterval(()=>{
      let lng = path.length>0 ? path[path.length-1][0] : initialPos[0];
      let lat = path.length>0 ? path[path.length-1][1] : initialPos[1];
      lng += (Math.random()-0.5)*0.0005;
      lat += (Math.random()-0.5)*0.0005;
      const pos = [lng, lat];
      path.push(pos);
      marker.setPosition(pos);
      map.setCenter(pos);
      polyline.setPath(path);
    }, 2000);
    console.log('模拟 GPS 启动');
  }

  function stopSimulation(){
    if(simulateInterval){ clearInterval(simulateInterval); simulateInterval=null; console.log('模拟 GPS 停止'); }
  }

  document.getElementById('startBtn').onclick = startSimulation;
  document.getElementById('stopBtn').onclick = stopSimulation;

  // ---------- MQTT 连接 ----------
  let client = null;
  const mqttConfig = {
    hostname: '5791e7b116.st1.iotda-device.cn-north-4.myhuaweicloud.com',
    clientId: '68bfe47d32771f177b5e1bf8_guiji-001_0_0_2025090914',
    username: '68bfe47d32771f177b5e1bf8_guiji-001',
    password: '7c4546ca912f90c51aefe02f5cd58757cfab4789aac12ab63a6cb905cf7e16bb',
    topic: '$oc/devices/68bfe47d32771f177b5e1bf8_guiji-001/sys/properties/set/#'
  };

  const statusEl = document.getElementById('status');
  const shadowEl = document.getElementById('shadow');

  document.getElementById('connectBtn').onclick = function(){
    if(client && client.connected) return;
    const url = `wss://${mqttConfig.hostname}/mqtt`;
    client = mqtt.connect(url, {
      clientId: mqttConfig.clientId,
      username: mqttConfig.username,
      password: mqttConfig.password,
      protocol: 'wss',
      clean: true
    });

    client.on('connect', ()=>{
      statusEl.innerText = 'MQTT状态: 已连接';
      client.subscribe(mqttConfig.topic, (err, granted)=>{
        if(err){
          console.error('订阅失败', err);
        } else {
          console.log('订阅成功', granted);
        }
      });
    });

    client.on('error', err=>{
      console.error('MQTT 错误:', err);
      statusEl.innerText = 'MQTT状态: 错误';
    });

    client.on('close', ()=>{
      statusEl.innerText = 'MQTT状态: 已断开';
      console.log('MQTT 已断开');
    });

    client.on('message', (topic, message)=>{
      try{
        const data = JSON.parse(message.toString());
        shadowEl.innerText = '物模型数据: ' + JSON.stringify(data);
      }catch(e){}
    });
  };

  document.getElementById('disconnectBtn').onclick = function(){
    if(client){ client.end(); client=null; statusEl.innerText='MQTT状态: 已断开'; }
  };
</script>

</body>
</html>
