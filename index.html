<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>GPS实时监控+轨迹</title>
  <!-- 高德地图JS SDK -->
  <script src="https://webapi.amap.com/maps?v=2.0&key=99aaad9da054b71f551fb168b5a88088"></script>
  <!-- MQTT.js -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 999;
      background: rgba(255,255,255,0.9);
      padding: 5px 10px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    #mapContainer {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <div id="controls">
    <button onclick="sendCommand('START')">开始</button>
    <button onclick="sendCommand('STOP')">停止</button>
  </div>
  <div id="mapContainer"></div>

  <script>
    // ---------- 高德地图初始化 ----------
    const map = new AMap.Map('mapContainer', {
      zoom: 15,
      center: [113.12345, 23.12345] // 初始中心
    });

    const marker = new AMap.Marker({
      position: [113.12345, 23.12345],
      map: map
    });

    // ---------- 初始化轨迹 ----------
    let path = []; // 空轨迹数组
    const polyline = new AMap.Polyline({
      path: path,
      strokeColor: "#FF0000",
      strokeWeight: 4,
      map: map
    });

    // ---------- 华为云 MQTT WSS 连接 ----------
    const mqttHost = "wss://5791e7b116.st1.iotda-device.cn-north-4.myhuaweicloud.com/mqtt";
    const mqttOptions = {
      clientId: "68bfe47d32771f177b5e1bf8_guiji-001_0_0_2025090908",
      username: "68bfe47d32771f177b5e1bf8_guiji-001",
      password: "591753c344ea181736aceffb9917a1bb", // 注意浏览器 WSS 可能需要签名
      keepalive: 60,
      reconnectPeriod: 2000
    };

    const client = mqtt.connect(mqttHost, mqttOptions);

    client.on('connect', () => {
      console.log('MQTT connected!');
      client.subscribe('/68bfe47d32771f177b5e1bf8_guiji-001/data', (err) => {
        if (!err) console.log('Subscribed to GPS data');
      });
    });

    client.on('error', (err) => {
      console.error('MQTT Error:', err);
    });

    // ---------- 处理 MQTT 消息 ----------
    client.on('message', (topic, message) => {
      try {
        const data = JSON.parse(message.toString());
        const lng = parseFloat(data.lon);
        const lat = parseFloat(data.lat);

        // ✅ 先检查经纬度是否合法
        if (!isNaN(lng) && !isNaN(lat)) {
            // 更新 Marker
            marker.setPosition([lng, lat]);
            map.setCenter([lng, lat]);

            // 更新轨迹
            path.push([lng, lat]);
            polyline.setPath(path);
        } else {
            console.warn('收到无效 GPS 数据:', data);
        }
      } catch (e) {
        console.error('解析GPS数据出错:', e);
      }
    });

    // ---------- 前端发送控制命令 ----------
    function sendCommand(cmd) {
      const payload = JSON.stringify({ command: cmd });
      client.publish('/68bfe47d32771f177b5e1bf8_guiji-001/command', payload);
      console.log('Command sent:', payload);
    }
  </script>
</body>
</html>
