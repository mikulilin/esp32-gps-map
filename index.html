<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>GPS 模拟 + 华为云物模型 + 高德地图</title>
<script src="https://webapi.amap.com/maps?v=2.0&key=99aaad9da054b71f551fb168b5a88088"></script>
<style>
html, body { height:100%; margin:0; }
#mapContainer { width:100%; height:100%; }
#controls {
  position: absolute;
  top: 10px;
  left: 10px;
  background: rgba(255,255,255,0.9);
  padding: 5px 10px;
  border-radius: 5px;
  box-shadow: 0 0 5px rgba(0,0,0,0.3);
  z-index: 999;
}
button { margin-right: 5px; }
#status { margin-top:5px; }
</style>
</head>
<body>
<div id="controls">
  <button id="startBtn">启动模拟</button>
  <button id="stopBtn">停止模拟</button>
  <button onclick="clearPath()">清除轨迹</button>
  <div id="status">物模型数据加载中...</div>
</div>
<div id="mapContainer"></div>

<script>
// ---------- 高德地图初始化 ----------
let initialPos = [108.073, 34.280]; // 默认西北农林科技大学北校区
const map = new AMap.Map('mapContainer', { zoom:16, center: initialPos });
const marker = new AMap.Marker({ position: initialPos, map: map });
let path = [];
const polyline = new AMap.Polyline({ path:[initialPos], strokeColor:"#FF0000", strokeWeight:4, map:map });

// ---------- 本地模拟 GPS ----------
let simulateInterval = null;
function startSimulation() {
  if(simulateInterval) return;
  simulateInterval = setInterval(()=>{
    let lng = path.length>0 ? path[path.length-1][0] : initialPos[0];
    let lat = path.length>0 ? path[path.length-1][1] : initialPos[1];
    lng += (Math.random()-0.5)*0.0005;
    lat += (Math.random()-0.5)*0.0005;
    const pos = [lng, lat];
    updateMap(pos);
  }, 2000);
}
function stopSimulation(){ if(simulateInterval){ clearInterval(simulateInterval); simulateInterval=null; } }
document.getElementById('startBtn').onclick=startSimulation;
document.getElementById('stopBtn').onclick=stopSimulation;
function clearPath(){ path=[initialPos]; polyline.setPath([initialPos]); marker.setPosition(initialPos); map.setCenter(initialPos); }

// ---------- 更新地图轨迹 ----------
function updateMap(pos){
  path.push(pos);
  marker.setPosition(pos);
  map.setCenter(pos);
  polyline.setPath(path);
}

// ---------- 云端物模型 API 配置 ----------
const projectId = 'YOUR_PROJECT_ID';
const deviceId = '68bfe47d32771f177b5e1bf8_guiji-001';
const username = 'YOUR_USERNAME';
const password = 'YOUR_PASSWORD';
const domain = 'YOUR_ACCOUNT_NAME';
const projectName = 'YOUR_PROJECT_NAME';
let token = '';

// 获取 Token
async function getToken(){
  const res = await fetch('https://iam.cn-north-4.myhuaweicloud.com/v3/auth/tokens',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      auth:{
        identity:{ methods:['password'], password:{ user:{ name:username, password:password, domain:{name:domain} } } },
        scope:{ project:{name:projectName} }
      }
    })
  });
  token = res.headers.get('X-Subject-Token');
  console.log('Token:', token);
}

// 获取设备物模型数据
async function getDeviceShadow(){
  if(!token) return;
  try{
    const res = await fetch(`https://iotda.cn-north-4.myhuaweicloud.com/v5/iot/${projectId}/devices/${deviceId}/shadow`, {
      headers:{ 'X-Auth-Token': token, 'Content-Type':'application/json' }
    });
    const data = await res.json();
    if(data.services && data.services[0] && data.services[0].properties){
      const props = data.services[0].properties;
      document.getElementById('status').innerText = `云端数据 - 经度: ${props.longitude}, 纬度: ${props.latitude}`;
    }
  }catch(e){ console.error('获取物模型失败', e); }
}

// ---------- 主流程 ----------
async function main(){
  await getToken();
  getDeviceShadow();
  setInterval(getDeviceShadow, 5000); // 每5秒刷新一次
}
main();
</script>
</body>
</html>
