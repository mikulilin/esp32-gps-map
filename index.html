<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>GPS 轨迹可视化</title>
  <script src="https://webapi.amap.com/maps?v=2.0&key=99aaad9da054b71f551fb168b5a88088"></script>
  <style>
    body, html {margin: 0; padding: 0; height: 100%; width: 100%;}
    #map {width: 100%; height: 100%;}
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    const deviceId = "2469496646";   // ← 替换
    const apiKey   = "version=2018-10-31&res=products%2FdyLIMxujKq%2Fdevices%2Fnbiot&et=1758183737&method=md5&sign=bbDmpi9BkOWjLa6HWBlf1g%3D%3D"; // ← 替换

    async function getData() {
      const url = `https://iot-api.heclouds.com/devices/${deviceId}/datapoints?datastream_id=GPS&limit=50`;
      const res = await fetch(url, { headers: {"api-key": apiKey}});
      const json = await res.json();

      if (!json.data || !json.data.datastreams) {
        alert("没有获取到数据，请检查 OneNET 设置");
        return;
      }

      const points = json.data.datastreams[0].datapoints.map(p => [
        p.value.lon,
        p.value.lat
      ]);

      drawMap(points);
    }

    function drawMap(points) {
      const map = new AMap.Map("map", {
        zoom: 15,
        center: points.length > 0 ? points[0] : [108.95,34.26]
      });

      if (points.length > 0) {
        const polyline = new AMap.Polyline({
          path: points,
          borderWeight: 3,
          strokeColor: "blue"
        });
        map.add(polyline);

        const marker = new AMap.Marker({
          position: points[points.length-1],
          title: "当前位置"
        });
        map.add(marker);

        map.setFitView([polyline]);
      }
    }

    getData();
  </script>
</body>
</html>
