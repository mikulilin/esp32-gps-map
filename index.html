<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>GPS 模拟 + 浏览器定位 + Node.js WebSocket</title>
<script src="https://webapi.amap.com/maps?v=2.0&key=99aaad9da054b71f551fb168b5a88088"></script>
<style>
html, body { height:100%; margin:0; }
#mapContainer { width:100%; height:100%; }
#controls {
  position: absolute;
  top: 10px;
  left: 10px;
  background: rgba(255,255,255,0.9);
  padding: 5px 10px;
  border-radius: 5px;
  box-shadow: 0 0 5px rgba(0,0,0,0.3);
  z-index: 999;
}
button { margin-right: 5px; margin-bottom: 5px; }
#status { margin-top: 5px; font-weight: bold; }
</style>
</head>
<body>
<div id="controls">
  <button id="startBtn">启动模拟</button>
  <button id="stopBtn">停止模拟</button>
  <button onclick="clearPath()">清除轨迹</button>
  <button id="connectBtn">连接 WebSocket</button>
  <button id="disconnectBtn">断开 WebSocket</button>
  <div id="status">WebSocket 状态: 未连接</div>
  <div id="modelData">物模型数据: 无</div>
</div>
<div id="mapContainer"></div>

<script>
let initialPos = [108.073, 34.280];
const map = new AMap.Map('mapContainer', { zoom:16, center:initialPos });
const marker = new AMap.Marker({ position: initialPos, map: map });

// ---------- 初始化轨迹 ----------
let path = [];
const savedPath = localStorage.getItem('gpsPath');
if(savedPath) {
  try{
    const parsed = JSON.parse(savedPath);
    path = parsed.filter(p => Array.isArray(p) && p.length===2 && !isNaN(p[0]) && !isNaN(p[1]));
  } catch(e){ path=[]; }
}
const polyline = new AMap.Polyline({ path: path.length>0?path:[initialPos], strokeColor:"#FF0000", strokeWeight:4, map:map });
if(path.length>0){ marker.setPosition(path[path.length-1]); map.setCenter(path[path.length-1]); }

// ---------- 浏览器定位 ----------
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(pos=>{
    initialPos = [pos.coords.longitude, pos.coords.latitude];
    marker.setPosition(initialPos);
    map.setCenter(initialPos);
    if(path.length===0){ path.push(initialPos); polyline.setPath(path); }
  }, err=>console.warn('定位失败', err));
}

// ---------- 清除轨迹 ----------
function clearPath(){
  path=[]; polyline.setPath([initialPos]); marker.setPosition(initialPos); map.setCenter(initialPos);
  localStorage.removeItem('gpsPath'); console.log('轨迹已清除');
}

// ---------- 模拟 GPS ----------
let simulateInterval = null;
function startSimulation(){ 
  if(simulateInterval) return;
  simulateInterval = setInterval(()=>{
    let lng = path.length>0?path[path.length-1][0]:initialPos[0];
    let lat = path.length>0?path[path.length-1][1]:initialPos[1];
    lng += (Math.random()-0.5)*0.0005;
    lat += (Math.random()-0.5)*0.0005;
    handleModelData({ longitude: lng, latitude: lat });
  }, 2000);
}
function stopSimulation(){ if(simulateInterval){ clearInterval(simulateInterval); simulateInterval=null; } }
document.getElementById('startBtn').onclick=startSimulation;
document.getElementById('stopBtn').onclick=stopSimulation;

// ---------- 更新地图轨迹 ----------
function handleModelData(data){
  const lng=parseFloat(data.longitude), lat=parseFloat(data.latitude);
  if(!isNaN(lng) && !isNaN(lat)){
    const pos=[lng,lat];
    marker.setPosition(pos); map.setCenter(pos);
    path.push(pos); 
    polyline.setPath(path); 
    localStorage.setItem('gpsPath', JSON.stringify(path));
    document.getElementById('modelData').innerText = `物模型数据: 经度 ${lng.toFixed(6)}, 纬度 ${lat.toFixed(6)}`;
  }
}

// ---------- WebSocket ----------
let ws=null;
function connectWS(){
  if(ws && ws.readyState===WebSocket.OPEN) return;

  // 自动生成 WebSocket 地址，根据页面协议和端口
  const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
  const host = window.location.hostname;
  const port = window.location.port || '3000'; // 默认端口3000，可根据 Node.js 修改
  const wsUrl = `${protocol}://${host}:${port}`;

  ws=new WebSocket(wsUrl);
  document.getElementById('status').innerText='WebSocket 状态: 连接中...';

  ws.onopen=()=>document.getElementById('status').innerText='WebSocket 状态: 已连接';

  ws.onmessage=event=>{
    try{ 
      const gpsData = JSON.parse(event.data);
      handleModelData({ longitude: gpsData.lng || gpsData.longitude, latitude: gpsData.lat || gpsData.latitude });
    } catch(e){ console.warn('解析 WebSocket 数据失败', e); }
  };

  ws.onclose=()=>document.getElementById('status').innerText='WebSocket 状态: 已断开';
}
function disconnectWS(){ if(ws) ws.close(); }
document.getElementById('connectBtn').onclick=connectWS;
document.getElementById('disconnectBtn').onclick=disconnectWS;
</script>
</body>
</html>
