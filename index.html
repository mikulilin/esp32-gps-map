<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>NB-IoT 实时轨迹 - AGC Web SDK 自动重连</title>
  <script src="agconnect-web-sdk.js"></script> <!-- 本地或官方 CDN SDK -->
  <script src="https://webapi.amap.com/maps?v=2.0&key=99aaad9da054b71f551fb168b5a88088"></script>
  <style>
    html, body { height:100%; margin:0; }
    #mapContainer { width:100%; height:100%; }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 5px 10px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      z-index: 999;
    }
    button { margin-right: 5px; margin-bottom: 5px; }
    #status { margin-top: 5px; font-weight: bold; }
  </style>
</head>
<body>
  <div id="controls">
    <button id="startBtn">启动模拟</button>
    <button id="stopBtn">停止模拟</button>
    <button onclick="clearPath()">清除轨迹</button>
    <div id="status">数据源: 未连接</div>
    <div id="modelData">物模型数据: 无</div>
  </div>
  <div id="mapContainer"></div>

  <script>
    // ---------- 地图初始化 ----------
    let initialPos = [108.073, 34.280];
    const map = new AMap.Map('mapContainer', { zoom:16, center: initialPos });
    const marker = new AMap.Marker({ position: initialPos, map: map });

    let path = [];
    const savedPath = localStorage.getItem('gpsPath');
    if(savedPath){ try{ path=JSON.parse(savedPath); }catch(e){ path=[]; } }

    const polyline = new AMap.Polyline({
      path: path.length>0 ? path : [initialPos],
      strokeColor:"#FF0000",
      strokeWeight:4,
      map: map
    });

    if(path.length>0){ marker.setPosition(path[path.length-1]); map.setCenter(path[path.length-1]); }

    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        const lng=pos.coords.longitude;
        const lat=pos.coords.latitude;
        initialPos=[lng,lat];
        marker.setPosition(initialPos);
        map.setCenter(initialPos);
        if(path.length===0){ path.push(initialPos); polyline.setPath(path); }
      });
    }

    function clearPath(){
      path=[]; polyline.setPath([initialPos]);
      marker.setPosition(initialPos); map.setCenter(initialPos);
      localStorage.removeItem('gpsPath');
    }

    // ---------- 模拟 GPS ----------
    let simulateInterval=null;
    function startSimulation(){
      if(simulateInterval) return;
      simulateInterval=setInterval(()=>{
        let lng=path.length>0 ? path[path.length-1][0]:initialPos[0];
        let lat=path.length>0 ? path[path.length-1][1]:initialPos[1];
        lng+=(Math.random()-0.5)*0.0005;
        lat+=(Math.random()-0.5)*0.0005;
        handleModelData({longitude: lng, latitude: lat});
      },2000);
      document.getElementById('status').innerText='数据源: 模拟 GPS';
    }
    function stopSimulation(){ if(simulateInterval){ clearInterval(simulateInterval); simulateInterval=null; } }
    document.getElementById('startBtn').onclick=startSimulation;
    document.getElementById('stopBtn').onclick=stopSimulation;

    function handleModelData(data){
      const lng=parseFloat(data.longitude);
      const lat=parseFloat(data.latitude);
      if(!isNaN(lng) && !isNaN(lat)){
        const pos=[lng,lat];
        marker.setPosition(pos);
        map.setCenter(pos);
        path.push(pos);
        polyline.setPath(path);
        localStorage.setItem('gpsPath',JSON.stringify(path));
        document.getElementById('modelData').innerText=`物模型数据: 经度 ${lng.toFixed(6)}, 纬度 ${lat.toFixed(6)}`;
      }
    }

    // ---------- AGC Web SDK 实时轨迹（自动重连） ----------
    var agConnectConfig = {
      "client": {
        "cp_id":"10086000893577194",
        "product_id":"68bfe47d32771f177b5e1bf8",
        "client_id":"1772358902709541760",
        "client_secret":"A1D79AD704620F0C758E0ACB8BF146B7762736BC70F884E7DAF8294A1EDD31FA",
        "project_id":"45672752-fa2e-43d2-9d8d-fbd6fb539b11",
        "app_id":"245150415728747952",
        "api_key":"DgEDANi9U4EG9MMr/5PBc2TaJLfTA6PYMUM2D6aiVqBrIPL9YqDJn+TQlsr/YHT/kqZyS7GDFizHe5YsBt87k1QuwcAHnzaEkRCX1g=="
      }
    };
    AGConnect.init(agConnectConfig);

    let wsClient = null;
    const deviceId = "68bfe47d32771f177b5e1bf8_guiji-001";

    async function connectRealtime(){
      try{
        wsClient = await AGConnect.IoTDA.Device.connect(deviceId);
        document.getElementById('status').innerText='数据源: AGC 实时';
        console.log('AGC WebSocket 已连接');

        wsClient.on('message', msg=>{
          if(msg.shadow && msg.shadow[0] && msg.shadow[0].reported && msg.shadow[0].reported.properties){
            handleModelData(msg.shadow[0].reported.properties);
          }
        });

        wsClient.on('disconnect', ()=>{
          console.warn('AGC WebSocket 已断开，3秒后尝试重连...');
          document.getElementById('status').innerText='数据源: 已断开，重连中...';
          setTimeout(connectRealtime, 3000);
        });

        wsClient.on('error', e=>{
          console.error('AGC WebSocket 错误', e);
        });

      }catch(e){
        console.error('AGC WebSocket 连接失败，3秒后重试', e);
        document.getElementById('status').innerText='数据源: 连接失败，重试中...';
        setTimeout(connectRealtime, 3000);
      }
    }

    connectRealtime(); // 启动实时连接
  </script>
</body>
</html>
