// ---------- åä¸ºäº‘ WSS MQTT (è®¾å¤‡æ¥å…¥) ----------
let client = null;
const mqttConfig = {
  hostname: '5791e7b116.st1.iotda-device.cn-north-4.myhuaweicloud.com',
  clientId: '68bfe47d32771f177b5e1bf8_guiji-001_0_0_2025090914',
  username: '68bfe47d32771f177b5e1bf8_guiji-001',
  password: '7c4546ca912f90c51aefe02f5cd58757cfab4789aac12ab63a6cb905cf7e16bb',
  topic: '$oc/devices/68bfe47d32771f177b5e1bf8_guiji-001/sys/properties/set/#'
};

// ---------- åä¸ºäº‘ WSS MQTT (åº”ç”¨æ¥å…¥) ----------
let appClient = null;
const mqttAppConfig = {
  hostname: "mqtts-cn-north-4.myhuaweicloud.com", // ç¡®è®¤æ§åˆ¶å°çš„MQTTæ¨é€åŸŸå
  port: 443,
  clientId: "webapp_" + Math.random().toString(16).substr(2, 8),
  username: "QpbDtCqL",  // access_key
  password: "yNy6DBpsHET9GYUTrPKJ4yAYSJd3Vgts", // access_code
  topic: "gpshtml" // è½¬å‘Topic
};

// ---------- è®¾å¤‡æ¥å…¥ ----------
function connectMQTT() {
  if (client && client.connected) return;
  const url = `wss://${mqttConfig.hostname}/mqtt`;
  console.log('è®¾å¤‡æ¥å…¥: å°è¯•è¿æ¥ WSS URL:', url);

  client = mqtt.connect(url, {
    clientId: mqttConfig.clientId,
    username: mqttConfig.username,
    password: mqttConfig.password,
    protocol: 'wss',
    clean: true
  });

  client.on('connect', () => {
    console.log('âœ… è®¾å¤‡MQTT å·²è¿æ¥');
    client.subscribe(mqttConfig.topic, (err) => {
      if (err) console.error('è®¢é˜…å¤±è´¥:', err);
      else console.log('è®¢é˜…æˆåŠŸ:', mqttConfig.topic);
    });
  });

  client.on('message', (topic, message) => {
    try {
      const data = JSON.parse(message.toString());
      handleModelData(data);
    } catch (e) {}
  });
}

function disconnectMQTT() {
  if (client && client.connected) {
    client.end();
    console.log('è®¾å¤‡MQTT å·²æ–­å¼€');
  }
}

// ---------- åº”ç”¨æ¥å…¥ ----------
function connectAppMQTT() {
  if (appClient && appClient.connected) return;
  const url = `wss://${mqttAppConfig.hostname}:${mqttAppConfig.port}/mqtt`;
  console.log("åº”ç”¨æ¥å…¥: å°è¯•è¿æ¥ WSS URL:", url);

  appClient = mqtt.connect(url, {
    clientId: mqttAppConfig.clientId,
    username: mqttAppConfig.username,
    password: mqttAppConfig.password,
    protocol: "wss",
    clean: true
  });

  appClient.on("connect", () => {
    console.log("âœ… åº”ç”¨MQTT å·²è¿æ¥");
    appClient.subscribe(mqttAppConfig.topic, (err) => {
      if (err) console.error("åº”ç”¨è®¢é˜…å¤±è´¥:", err);
      else console.log("åº”ç”¨å·²è®¢é˜…:", mqttAppConfig.topic);
    });
  });

  appClient.on("message", (topic, message) => {
    try {
      const data = JSON.parse(message.toString());
      console.log("ğŸ“© åº”ç”¨æ”¶åˆ°æ•°æ®:", data);
      handleModelData(data);
    } catch (e) {}
  });
}

function disconnectAppMQTT() {
  if (appClient && appClient.connected) {
    appClient.end();
    console.log("åº”ç”¨MQTT å·²æ–­å¼€");
  }
}
