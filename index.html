<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>GPS 模拟 + 华为云物模型实时显示</title>
<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script src="https://webapi.amap.com/maps?v=2.0&key=你的高德Key"></script>
<style>
html, body { height:100%; margin:0; }
#mapContainer { width:100%; height:100%; }
#controls { position:absolute; top:10px; left:10px; background:rgba(255,255,255,0.9); padding:5px 10px; border-radius:5px; z-index:999; }
button { margin:2px 5px 2px 0; }
#coords { display:block; margin-top:5px; font-weight:bold; }
</style>
</head>
<body>
<div id="controls">
  <button id="startBtn">启动模拟</button>
  <button id="stopBtn">停止模拟</button>
  <button onclick="clearSimulation()">清除模拟轨迹</button>
  <button onclick="disconnectMQTT()">断开云端连接</button>
  <span id="coords">经纬度: -- , --</span>
</div>
<div id="mapContainer"></div>

<script>
// ---------- 初始坐标 ----------
let initialPos = [108.073, 34.280];
const map = new AMap.Map('mapContainer', { zoom:16, center:initialPos });

// ---------- 红色模拟轨迹 ----------
let pathSim = [], markerSim = new AMap.Marker({ position:initialPos, map:map });
const polylineSim = new AMap.Polyline({ path:[initialPos], strokeColor:"#FF0000", strokeWeight:3, map:map });

// ---------- 蓝色云端轨迹 ----------
let pathCloud = [], markerCloud = new AMap.Marker({ position:initialPos, map:map });
const polylineCloud = new AMap.Polyline({ path:[initialPos], strokeColor:"#0000FF", strokeWeight:4, map:map });

// ---------- 浏览器定位 ----------
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(pos=>{
    const lng = pos.coords.longitude, lat = pos.coords.latitude;
    initialPos = [lng, lat];
    markerSim.setPosition(initialPos);
    markerCloud.setPosition(initialPos);
    map.setCenter(initialPos);
  });
}

// ---------- 模拟 GPS ----------
let simulateInterval = null;
function startSimulation(){
  if(simulateInterval) return;
  simulateInterval = setInterval(()=>{
    let lng = pathSim.length>0?pathSim[pathSim.length-1][0]:initialPos[0];
    let lat = pathSim.length>0?pathSim[pathSim.length-1][1]:initialPos[1];
    lng += (Math.random()-0.5)*0.0005;
    lat += (Math.random()-0.5)*0.0005;
    const pos = [lng, lat];
    pathSim.push(pos); polylineSim.setPath(pathSim);
    markerSim.setPosition(pos); map.setCenter(pos);
  },2000);
}
function stopSimulation(){ if(simulateInterval){ clearInterval(simulateInterval); simulateInterval=null; } }
function clearSimulation(){ pathSim=[]; polylineSim.setPath([initialPos]); markerSim.setPosition(initialPos); }

// ---------- MQTT 连接华为云 ----------
let client = null;
const mqttConfig = {
  hostname: '5791e7b116.st1.iotda-device.cn-north-4.myhuaweicloud.com',
  clientId: '68bfe47d32771f177b5e1bf8_guiji-001_web_0_0_2025090914',
  username: '68bfe47d32771f177b5e1bf8_guiji-001',
  password: '你的设备密码或生成的Token',
  topic: '$oc/devices/68bfe47d32771f177b5e1bf8_guiji-001/sys/properties/report'
};

function connectMQTT(){
  if(client && client.connected) return;
  const url = `wss://${mqttConfig.hostname}:443/mqtt`; // WSS 默认443端口
  client = mqtt.connect(url, {
    clientId: mqttConfig.clientId,
    username: mqttConfig.username,
    password: mqttConfig.password,
    protocol: 'wss',
    clean: true
  });

  client.on('connect',()=>console.log('MQTT 已连接'));
  client.on('error', err=>console.error('MQTT 错误:', err));
  client.on('close',()=>console.log('MQTT 已断开'));
  client.on('message', (topic, message)=>{
    try{
      const data = JSON.parse(message.toString());
      handleCloudMessage(data);
    }catch(e){}
  });

  client.subscribe(mqttConfig.topic);
}

function disconnectMQTT(){
  if(client && client.connected){
    client.end();
    console.log('已手动断开云端连接');
  }
}

// ---------- 更新蓝色云端轨迹 ----------
function handleCloudMessage(data){
  // 物模型格式：{"services":[{"service_id":"001","properties":{"longitude":120.456,"latitude":30.123}}]}
  if(data.services && data.services[0] && data.services[0].properties){
    const props = data.services[0].properties;
    const lng = parseFloat(props.longitude), lat = parseFloat(props.latitude);
    if(!isNaN(lng) && !isNaN(lat)){
      const pos = [lng, lat];
      pathCloud.push(pos);
      polylineCloud.setPath(pathCloud);
      markerCloud.setPosition(pos);
      map.setCenter(pos);
      document.getElementById('coords').innerText = `经纬度: ${lng.toFixed(6)} , ${lat.toFixed(6)}`;
    }
  }
}

// ---------- 按钮绑定 ----------
document.getElementById('startBtn').onclick = startSimulation;
document.getElementById('stopBtn').onclick = stopSimulation;

// 自动连接华为云（不安全，仅测试）
connectMQTT();
