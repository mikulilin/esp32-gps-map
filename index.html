<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>华为云设备影子 + 高德地图轨迹</title>
<script src="https://webapi.amap.com/maps?v=2.0&key=99aaad9da054b71f551fb168b5a88088"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
<style>
  html, body { height:100%; margin:0; }
  #mapContainer { width:100%; height:100%; }
  #controls {
    position: absolute;
    top: 10px; left: 10px;
    background: rgba(255,255,255,0.9);
    padding: 10px; border-radius:5px;
    z-index: 999;
  }
  #controls div { margin-bottom:5px; }
</style>
</head>
<body>
<div id="mapContainer"></div>
<div id="controls">
  <div id="longitude">经度: --</div>
  <div id="latitude">纬度: --</div>
  <div id="time">时间: --</div>
  <button onclick="clearPath()">清除轨迹</button>
</div>

<script>
  // ---------- 配置AK/SK和设备信息 ----------
  const AK = "gpsguiji";
  const SK = "123456guiji";
  const PROJECT_ID = "45672752-fa2e-43d2-9d8d-fbd6fb539b11";
  const DEVICE_ID = "68bfe47d32771f177b5e1bf8_guiji-001";
  const REGION = "5791e7b116.st1"; // 华为云域名前缀

  // ---------- 初始化地图 ----------
  let initialPos = [108.073, 34.280]; // 默认坐标
  const map = new AMap.Map('mapContainer', { zoom:16, center:initialPos });
  const marker = new AMap.Marker({ position: initialPos, map:map });
  let path = [];
  const polyline = new AMap.Polyline({ path:[initialPos], strokeColor:"#FF0000", strokeWeight:4, map:map });

  function clearPath() {
    path=[];
    polyline.setPath([initialPos]);
    marker.setPosition(initialPos);
    map.setCenter(initialPos);
    console.log('轨迹已清除');
  }

  // ---------- HMAC-SHA256签名 ----------
  function getSignature(method, uri, ak, sk, timestamp) {
    const signingStr = `${method}\n${uri}\n${timestamp}`;
    const hmac = CryptoJS.HmacSHA256(signingStr, sk);
    return "SDK-HMAC-SHA256 " + ak + ":" + CryptoJS.enc.Base64.stringify(hmac);
  }

  // ---------- 拉取影子数据 ----------
  async function fetchShadow() {
    try {
      const apiUri = `/v5/iot/${PROJECT_ID}/devices/${DEVICE_ID}/shadow`;
      const apiUrl = `https://${REGION}.iotda-app.cn-north-4.myhuaweicloud.com${apiUri}`;
      const timestamp = new Date().toISOString();
      const signature = getSignature("GET", apiUri, AK, SK, timestamp);

      const res = await fetch(apiUrl, {
        method:"GET",
        headers: {
          "Authorization": signature,
          "X-Sdk-Date": timestamp
        }
      });
      const data = await res.json();
      const reported = data.shadow[0]?.reported?.properties;
      if (!reported) return null;

      return { 
        longitude: reported.longitude,
        latitude: reported.latitude,
        eventTime: reported.eventTime
      };
    } catch (err) {
      console.error("获取影子失败:", err);
      return null;
    }
  }

  // ---------- 实时更新 ----------
  async function updateMap() {
    const props = await fetchShadow();
    if (props) {
      const pos = [parseFloat(props.longitude), parseFloat(props.latitude)];
      marker.setPosition(pos);
      map.setCenter(pos);
      path.push(pos);
      polyline.setPath(path);
      document.getElementById("longitude").innerText = `经度: ${pos[0]}`;
      document.getElementById("latitude").innerText = `纬度: ${pos[1]}`;
      document.getElementById("time").innerText = `时间: ${props.eventTime}`;
    }
  }

  setInterval(updateMap, 5000); // 每5秒刷新一次
</script>
</body>
</html>
