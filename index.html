<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>GPS 模拟 + 浏览器定位 + 华为云 WSS MQTT</title>
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://webapi.amap.com/maps?v=2.0&key=99aaad9da054b71f551fb168b5a88088"></script>
  <style>
    html, body { height:100%; margin:0; }
    #mapContainer { width:100%; height:100%; }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255,255,255,0.9);
      padding: 5px 10px;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      z-index: 999;
    }
    button { margin-right: 5px; margin-top: 2px; }
    #coords, #status { display:block; margin-top:5px; font-weight:bold; }
  </style>
</head>
<body>
<div id="controls">
  <button id="startBtn">启动模拟</button>
  <button id="stopBtn">停止模拟</button>
  <button onclick="clearPath()">清除轨迹</button>
  <button onclick="connectMQTT()">连接华为云 MQTT</button>
  <button onclick="disconnectMQTT()">断开云端</button>
  <span id="coords">经纬度: -- , --</span>
  <span id="status">状态: 未连接</span>
</div>
<div id="mapContainer"></div>

<script>
let initialPos = [108.073, 34.280];
const map = new AMap.Map('mapContainer', { zoom:16, center:initialPos });
const marker = new AMap.Marker({ position:initialPos, map: map });

// ---------- 初始化轨迹 ----------
let path = [];
const savedPath = localStorage.getItem('gpsPath');
if (savedPath) {
  try {
    const parsed = JSON.parse(savedPath);
    path = parsed.filter(p => Array.isArray(p) && p.length===2 && !isNaN(p[0]) && !isNaN(p[1]));
  } catch(e){ path=[]; }
}
const polyline = new AMap.Polyline({ path:path.length>0?path:[initialPos], strokeColor:"#FF0000", strokeWeight:4, map:map });
if(path.length>0){ marker.setPosition(path[path.length-1]); map.setCenter(path[path.length-1]); }

// ---------- 浏览器定位 ----------
if(navigator.geolocation){
  navigator.geolocation.getCurrentPosition(position=>{
    const lng=position.coords.longitude, lat=position.coords.latitude;
    initialPos=[lng,lat];
    marker.setPosition(initialPos); map.setCenter(initialPos);
    if(path.length===0){ path.push(initialPos); polyline.setPath(path); }
  }, error=>{ console.warn('定位失败，使用默认坐标', error); });
}

// ---------- 清除轨迹 ----------
function clearPath(){ path=[]; polyline.setPath([initialPos]); marker.setPosition(initialPos); map.setCenter(initialPos); localStorage.removeItem('gpsPath'); }

// ---------- 模拟 GPS ----------
let simulateInterval = null;
function startSimulation(){
  if(simulateInterval) return;
  simulateInterval = setInterval(()=>{
    let lng = path.length>0?path[path.length-1][0]:initialPos[0];
    let lat = path.length>0?path[path.length-1][1]:initialPos[1];
    lng += (Math.random()-0.5)*0.0005;
    lat += (Math.random()-0.5)*0.0005;
    const pos=[lng,lat];
    marker.setPosition(pos); map.setCenter(pos);
    path.push(pos); polyline.setPath(path);
    localStorage.setItem('gpsPath', JSON.stringify(path));
    document.getElementById('coords').innerText = `经纬度: ${lng.toFixed(6)} , ${lat.toFixed(6)}`;
  },2000);
}
function stopSimulation(){ if(simulateInterval){ clearInterval(simulateInterval); simulateInterval=null; } }
document.getElementById('startBtn').onclick=startSimulation;
document.getElementById('stopBtn').onclick=stopSimulation;

// ---------- 华为云 WSS MQTT ----------
let client=null;
const mqttConfig = {
  hostname: '5791e7b116.st1.iotda-device.cn-north-4.myhuaweicloud.com',
  clientId: '68bfe47d32771f177b5e1bf8_guiji-001_0_0_2025090914',
  username: '68bfe47d32771f177b5e1bf8_guiji-001',
  password: '7c4546ca912f90c51aefe02f5cd58757cfab4789aac12ab63a6cb905cf7e16bb',
  topic: '$oc/devices/68bfe47d32771f177b5e1bf8_guiji-001/sys/properties/report'
};

function updateStatus(text, color='green'){
  const statusEl = document.getElementById('status');
  if(statusEl){ statusEl.innerText = '状态: ' + text; statusEl.style.color = color; }
}

function connectMQTT(){
  if(client && client.connected) return;
  updateStatus('连接中...', 'orange');
  const url = `wss://${mqttConfig.hostname}:443/mqtt`;
  client = mqtt.connect(url, {
    clientId:mqttConfig.clientId,
    username:mqttConfig.username,
    password:mqttConfig.password,
    protocol:'wss',
    clean:true,
    reconnectPeriod:0  // 禁止自动重连
  });

  client.on('connect',()=>updateStatus('已连接', 'green'));
  client.on('error', err=>updateStatus('连接错误', 'red'));
  client.on('close', ()=>updateStatus('已断开', 'gray'));

  // 不上传模拟数据到云端，所以不处理 message
  // client.subscribe(mqttConfig.topic);
}

function disconnectMQTT(){
  if(client){
    client.end(true, ()=>updateStatus('已手动断开', 'gray'));
  }
}
</script>
</body>
</html>
