<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>华为云设备影子 + 高德地图轨迹</title>
<script src="https://webapi.amap.com/maps?v=2.0&key=99aaad9da054b71f551fb168b5a88088"></script>
<style>
  html, body { height:100%; margin:0; }
  #mapContainer { width:100%; height:100%; }
  #controls {
    position: absolute; top: 10px; left: 10px;
    background: rgba(255,255,255,0.9);
    padding: 10px; border-radius:5px;
    z-index: 999;
  }
</style>
</head>
<body>
<div id="mapContainer"></div>
<div id="controls">
  <div id="longitude">经度: --</div>
  <div id="latitude">纬度: --</div>
  <div id="time">时间: --</div>
  <button onclick="clearPath()">清除轨迹</button>
</div>

<script>
let initialPos = [108.073, 34.280];
const map = new AMap.Map('mapContainer', { zoom:16, center:initialPos });
const marker = new AMap.Marker({ position: initialPos, map:map });
let path = [];
const polyline = new AMap.Polyline({ path:[initialPos], strokeColor:"#FF0000", strokeWeight:4, map:map });

function clearPath() {
  path=[]; polyline.setPath([initialPos]); marker.setPosition(initialPos); map.setCenter(initialPos);
}

// 从中转服务器获取设备影子
async function fetchShadow() {
  try {
    const res = await fetch('/api/shadow');
    const data = await res.json();
    if (!data.longitude) return null;
    return [parseFloat(data.longitude), parseFloat(data.latitude), data.eventTime];
  } catch (err) {
    console.error(err);
    return null;
  }
}

async function updateMap() {
  const props = await fetchShadow();
  if (!props) return;
  const [lng, lat, time] = props;
  const pos = [lng, lat];
  marker.setPosition(pos);
  map.setCenter(pos);
  path.push(pos);
  polyline.setPath(path);
  document.getElementById('longitude').innerText = `经度: ${lng}`;
  document.getElementById('latitude').innerText = `纬度: ${lat}`;
  document.getElementById('time').innerText = `时间: ${time}`;
}

setInterval(updateMap, 5000);
</script>
</body>
</html>
