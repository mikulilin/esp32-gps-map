<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ESP32 GPS 模拟/显示</title>
<script src="https://webapi.amap.com/maps?v=2.0&key=99aaad9da054b71f551fb168b5a88088"></script>
<style>
  html, body { height:100%; margin:0; }
  #mapContainer { width:100%; height:100%; }
  #controls {
    position: absolute;
    top: 10px; left: 10px;
    background: rgba(255,255,255,0.9);
    padding: 10px; border-radius:5px;
    z-index: 999;
  }
  #controls div { margin-bottom:5px; }
  button { margin-right:5px; }
</style>
</head>
<body>
<div id="mapContainer"></div>
<div id="controls">
  <div id="status">状态: 未连接</div>
  <div id="longitude">经度: --</div>
  <div id="latitude">纬度: --</div>
  <div id="time">时间: --</div>
  <button id="connectBtn">连接ESP32</button>
  <button id="simulateBtn">开始模拟</button>
</div>

<script>
  const defaultPos = [108.073, 34.280]; // 默认坐标
  let posData = { longitude: defaultPos[0], latitude: defaultPos[1], eventTime: '--' };
  let simulate = false;
  let connect = false;

  const map = new AMap.Map('mapContainer', { zoom:16, center:defaultPos });
  const marker = new AMap.Marker({ position: defaultPos, map:map });
  let path = [];
  const polyline = new AMap.Polyline({ path:[defaultPos], strokeColor:"#FF0000", strokeWeight:4, map:map });

  document.getElementById('connectBtn').addEventListener('click', () => {
    connect = !connect;
    document.getElementById('connectBtn').innerText = connect ? '断开ESP32' : '连接ESP32';
    if(!connect) document.getElementById('status').innerText = '状态: 未连接';
  });

  document.getElementById('simulateBtn').addEventListener('click', () => {
    simulate = !simulate;
    document.getElementById('simulateBtn').innerText = simulate ? '停止模拟' : '开始模拟';
    if(!simulate){
      posData = { longitude: defaultPos[0], latitude: defaultPos[1], eventTime: '--' };
      marker.setPosition(defaultPos);
      map.setCenter(defaultPos);
      path = [defaultPos];
      polyline.setPath(path);
      document.getElementById('status').innerText = '状态: 未连接';
      document.getElementById('longitude').innerText = `经度: ${posData.longitude}`;
      document.getElementById('latitude').innerText = `纬度: ${posData.latitude}`;
      document.getElementById('time').innerText = `时间: ${posData.eventTime}`;
    }
  });

  async function updateMap() {
    if(simulate){
      const offset = 0.001;
      posData = {
        longitude: defaultPos[0] + (Math.random()*2-1)*offset,
        latitude: defaultPos[1] + (Math.random()*2-1)*offset,
        eventTime: new Date().toLocaleTimeString()
      };
      document.getElementById('status').innerText = '状态: 模拟中';
    } else if(connect){
      try{
        const res = await fetch('/api/gps');
        if(res.ok){
          const data = await res.json();
          if(data.longitude && data.latitude){
            posData = data;
            document.getElementById('status').innerText = '状态: 已连接';
          } else {
            document.getElementById('status').innerText = '状态: 等待ESP32数据';
            return;
          }
        } else {
          document.getElementById('status').innerText = '状态: 等待ESP32数据';
          return;
        }
      }catch(e){
        document.getElementById('status').innerText = '状态: 连接失败';
        console.error(e);
        return;
      }
    }

    const pos = [parseFloat(posData.longitude), parseFloat(posData.latitude)];
    marker.setPosition(pos);
    map.setCenter(pos);
    path.push(pos);
    polyline.setPath(path);
    document.getElementById('longitude').innerText = `经度: ${posData.longitude}`;
    document.getElementById('latitude').innerText = `纬度: ${posData.latitude}`;
    document.getElementById('time').innerText = `时间: ${posData.eventTime}`;
  }

  setInterval(updateMap, 1000);
</script>
</body>
</html>
