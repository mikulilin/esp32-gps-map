<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>ESP32 GPS 轨迹</title>
  <style>
    #map { width: 100%; height: 100vh; }
  </style>
  <script src="https://webapi.amap.com/maps?v=2.0&key=99aaad9da054b71f551fb168b5a88088"></script>
</head>
<body>
  <div id="map"></div>

  <script>
    const map = new AMap.Map("map", {
      zoom: 14,
      center: [108.073, 34.280],
    });

    let polyline = null;
    let marker = null;

    async function fetchData() {
      try {
        const res = await fetch("/api/gps");
        const data = await res.json();

        if (data.length === 0) return;

        const path = data.map(p => [p.longitude, p.latitude]);

        if (polyline) map.remove(polyline);
        polyline = new AMap.Polyline({
          path,
          strokeColor: "#3366FF",
          strokeWeight: 5
        });
        map.add(polyline);

        const last = path[path.length - 1];
        if (marker) map.remove(marker);
        marker = new AMap.Marker({ position: last });
        map.add(marker);

        map.setCenter(last);
      } catch (e) {
        console.error("获取数据失败", e);
      }
    }

    setInterval(fetchData, 5000); // 每5秒更新
  </script>
</body>
</html>

